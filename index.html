<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard RRHH - Gr√°ficos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        /* --- ESTILOS CSS --- */
        :root {
            /* Tema Claro (default) */
            --primary: #007bff;
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --text-main: #343a40;
            --text-secondary: #6c757d;
            --gradient-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --color-celeste: #29b6f6; 
            --color-verde: #28a745; 
            --color-rojo: #dc3545; 
            --color-amarillo: #ffc107; 
            --color-gris: #6c757d; 
        }
        
        /* Tema Oscuro */
        [data-theme="dark"] {
            --primary: #aea1ff;
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --border: #2d3748;
            --text-main: #e2e8f0;
            --text-secondary: #a0aec0;
            --gradient-bg: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
        }
        
        /* Transici√≥n suave al cambiar de tema */
        body, .container, .chart-box, .action-button {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            background-color: var(--bg);
            padding: 10px 15px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-main);
        }

        .container {
            width: 100%;
            max-width: 1400px; 
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden; 
            box-sizing: border-box;
        }

        h3 { 
            color: var(--primary); 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 8px; 
            margin-bottom: 20px; 
            font-size: 1.4rem;
            font-weight: 500;
        }

        /* Contenedor de Gr√°ficos */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--gradient-bg);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }
        .chart-box {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 4px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .chart-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--dynamic-gradient, linear-gradient(90deg, #667eea 0%, #764ba2 100%));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .chart-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
        }
        .chart-box:hover::before {
            opacity: 1;
        }
        .chart-box h4 {
            margin: 0 0 15px 0;
            font-size: 0.95rem;
            color: var(--text-main);
            font-weight: 700;
            text-align: center;
            letter-spacing: 0.3px;
        }
        .chart-box canvas {
            max-width: 200px !important;
            max-height: 200px !important;
            height: auto !important;
        }

        .kpi-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            min-height: 200px;
        }
        .kpi-value {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }
        .kpi-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Botones de Acciones R√°pidas */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 40px;
            padding: 30px;
            flex-wrap: wrap;
        }
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            background: var(--card-bg);
            padding: 25px 35px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid var(--btn-color);
            opacity: 0.95;
            min-width: 160px;
        }
        .action-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
            border-width: 2px;
            opacity: 1;
            background: linear-gradient(135deg, white 0%, rgba(255,255,255,0.98) 100%);
        }
        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            background: var(--btn-color);
            color: white;
            transition: all 0.3s ease;
        }
        .action-button:hover .action-icon {
            transform: scale(1.1);
        }
        .action-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
        }
        .action-button.legajo {
            --btn-color: #667eea;
        }
        .action-button.pendientes {
            --btn-color: #f5576c;
        }
        .action-button.firmados {
            --btn-color: #43e97b;
        }

        .hidden { 
            display: none; 
        }

        /* Mensajes de Estado */
        .status-msg { 
            text-align: center; 
            color: var(--text-secondary); 
            padding: 30px; 
            font-style: italic; 
        }

        /* Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Media Queries para responsividad */
        @media (max-width: 768px) {
            body { padding: 20px; }
            .container { padding: 20px; }
            .charts-container { grid-template-columns: 1fr; }
        }
        @media (max-width: 1200px) and (min-width: 769px) {
            .charts-container { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div class="container">
    <h3>Estad√≠sticas Globales</h3>
    
    <div id="panelEstado" class="status-msg">
        <div class="loader"></div>
        <p>Cargando gr√°ficos...</p>
    </div>

    <div id="chartsGlobales" class="charts-container hidden">
        <div class="chart-box">
            <h4>Total de Empleados</h4>
            <div id="kpiNumEmpleados" class="kpi-card"></div>
        </div>
        <div class="chart-box">
            <h4>Categor√≠as</h4>
            <canvas id="chartCategoriasGlobal"></canvas>
        </div>
        <div class="chart-box">
            <h4>Recibos Firmados</h4>
            <canvas id="chartFirmadoGlobal"></canvas>
        </div>
        <div class="chart-box">
            <h4>Conformidad</h4>
            <canvas id="chartConformidadGlobal"></canvas>
        </div>
    </div>

    <div class="quick-actions">
        <div class="action-button legajo" onclick="irALegajos()">
            <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </div>
            <div class="action-label">Legajos</div>
        </div>
        
        <div class="action-button pendientes" onclick="irAPendientes()">
            <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="action-label">Pendientes de Firmar</div>
        </div>
        
        <div class="action-button firmados" onclick="irAFirmados()">
            <div class="action-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="action-label">Firmados</div>
        </div>
    </div>
</div>

<script>
    const API_DASHBOARD_URL = 'https://square-regular-honeybee.ngrok-free.app/webhook/dashboard_rrhh'; 
    
    let chartCategoriasGlobalInstance = null;
    let chartFirmadoGlobalInstance = null;
    let chartConformidadGlobalInstance = null;
    
    // ========== GESTI√ìN DE TEMA DESDE PLATAFORMA ==========
    /**
     * Lee el tema desde m√∫ltiples fuentes (cookie, URL, postMessage) y lo aplica
     * Soporta integraci√≥n con plataforma mediante:
     * 1. Cookie: spaceThemeStore (mismo dominio)
     * 2. URL: ?darkMode=true&primaryColor=%23aea1ff
     * 3. postMessage: para iframes (parent env√≠a tema)
     */
    function aplicarTema(themeData) {
        try {
            console.log('üé® Aplicando tema:', themeData);
            
            // Aplicar modo dark/light
            if (themeData.darkMode === true) {
                document.documentElement.setAttribute('data-theme', 'dark');
                console.log('üåô Modo oscuro aplicado');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                console.log('‚òÄÔ∏è Modo claro aplicado');
            }
            
            // Aplicar color primario personalizado si est√° disponible
            if (themeData.primaryColor) {
                document.documentElement.style.setProperty('--primary', themeData.primaryColor);
                console.log('üé® Color primario personalizado aplicado:', themeData.primaryColor);
            }
            
            return true;
        } catch (error) {
            console.error('‚ùå Error al aplicar tema:', error);
            return false;
        }
    }
    
    function leerTemaDeCookie() {
        try {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'spaceThemeStore') {
                    const spaceThemeCookie = decodeURIComponent(value);
                    console.log('üç™ Cookie de tema encontrada');
                    return JSON.parse(spaceThemeCookie);
                }
            }
        } catch (error) {
            console.error('‚ùå Error al leer cookie:', error);
        }
        return null;
    }
    
    function leerTemaDeURL() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const darkMode = urlParams.get('darkMode');
            const primaryColor = urlParams.get('primaryColor');
            
            if (darkMode !== null) {
                console.log('üîó Par√°metros de tema encontrados en URL');
                return {
                    darkMode: darkMode === 'true',
                    primaryColor: primaryColor || null
                };
            }
        } catch (error) {
            console.error('‚ùå Error al leer par√°metros de URL:', error);
        }
        return null;
    }
    
    function aplicarTemaPlataforma() {
        // Prioridad 1: Leer de Cookie (mismo dominio)
        let themeData = leerTemaDeCookie();
        if (themeData) {
            console.log('‚úÖ Tema obtenido desde Cookie');
            aplicarTema(themeData);
            return;
        }
        
        // Prioridad 2: Leer de URL (iframe o link directo)
        themeData = leerTemaDeURL();
        if (themeData) {
            console.log('‚úÖ Tema obtenido desde URL');
            aplicarTema(themeData);
            return;
        }
        
        // Prioridad 3: Usar tema por defecto
        console.log('‚ÑπÔ∏è No se encontr√≥ configuraci√≥n de tema, usando modo claro por defecto');
        document.documentElement.setAttribute('data-theme', 'light');
    }
    
    // Escuchar mensajes de postMessage (para iframe)
    window.addEventListener('message', (event) => {
        try {
            // Validar que el mensaje tenga el formato esperado
            if (event.data && typeof event.data === 'object' && 'darkMode' in event.data) {
                console.log('üì® Tema recibido via postMessage:', event.data);
                aplicarTema(event.data);
            }
        } catch (error) {
            console.error('‚ùå Error al procesar postMessage:', error);
        }
    });
    
    // Aplicar tema al cargar la p√°gina
    aplicarTemaPlataforma();
    
    // Si est√° en iframe, solicitar tema al parent
    if (window.parent !== window) {
        console.log('üñºÔ∏è Detectado iframe, solicitando tema al parent...');
        window.parent.postMessage({ type: 'requestTheme' }, '*');
    }
    // ========== FIN GESTI√ìN DE TEMA ==========
    
    function crearGraficoNumEmpleadosGlobal(data) {
        const kpiContainer = document.getElementById('kpiNumEmpleados');
        const item = data[0]; // Solo hay un elemento: numEmpleados
        
        kpiContainer.innerHTML = `
            <div class="kpi-value">${item.value}</div>
            <div class="kpi-label">${item.label}</div>
        `;
        
        // Aplicar gradiente din√°mico al borde de la tarjeta
        const chartBox = kpiContainer.closest('.chart-box');
        chartBox.style.setProperty('--dynamic-gradient', 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)');
    }
    
    function crearGraficoCategoriasGlobal(data) {
        const ctx = document.getElementById('chartCategoriasGlobal').getContext('2d');
        if (chartCategoriasGlobalInstance) chartCategoriasGlobalInstance.destroy();
        
        const labels = data.map(item => item.label);
        const values = data.map(item => item.value);
        const colors = ['#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140', '#30cfd0', '#330867', '#a8edea', '#fed6e3'];
        
        // Crear array de datos con colores y ordenar por valor descendente
        const dataWithColors = data.map((item, index) => ({
            value: item.value,
            color: colors[index % colors.length]
        })).sort((a, b) => b.value - a.value);
        
        // Crear gradiente din√°mico basado en predominancia
        const gradientColors = dataWithColors.map(item => item.color).join(', ');
        const chartBox = document.getElementById('chartCategoriasGlobal').closest('.chart-box');
        chartBox.style.setProperty('--dynamic-gradient', `linear-gradient(90deg, ${gradientColors})`);
        
        chartCategoriasGlobalInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            boxWidth: 14, 
                            font: { size: 11, weight: '500' },
                            padding: 12,
                            color: '#2d3748'
                        } 
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value, ctx) => {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return percentage + '%';
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
    
    function crearGraficoFirmadoGlobal(data) {
        const ctx = document.getElementById('chartFirmadoGlobal').getContext('2d');
        if (chartFirmadoGlobalInstance) chartFirmadoGlobalInstance.destroy();
        
        const labels = data.filter(item => item.value > 0).map(item => item.label);
        const values = data.filter(item => item.value > 0).map(item => item.value);
        const colorMap = { 'Si': '#43e97b', 'No': '#fa709a', 'Pendiente': '#a8b8d8', 'Sin dato': '#cbd5e0' };
        const colors = labels.map(label => colorMap[label] || '#a8b8d8');
        
        // Crear array de datos con colores y ordenar por valor descendente
        const dataWithColors = data.filter(item => item.value > 0).map(item => ({
            value: item.value,
            color: colorMap[item.label] || '#a8b8d8'
        })).sort((a, b) => b.value - a.value);
        
        // Crear gradiente din√°mico basado en predominancia
        const gradientColors = dataWithColors.map(item => item.color).join(', ');
        const chartBox = document.getElementById('chartFirmadoGlobal').closest('.chart-box');
        chartBox.style.setProperty('--dynamic-gradient', `linear-gradient(90deg, ${gradientColors})`);
        
        chartFirmadoGlobalInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            boxWidth: 14, 
                            font: { size: 11, weight: '500' },
                            padding: 12,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-main').trim()
                        } 
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value, ctx) => {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return percentage + '%';
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
    
    function crearGraficoConformidadGlobal(data) {
        const ctx = document.getElementById('chartConformidadGlobal').getContext('2d');
        if (chartConformidadGlobalInstance) chartConformidadGlobalInstance.destroy();
        
        const labels = data.filter(item => item.value > 0).map(item => item.label);
        const values = data.filter(item => item.value > 0).map(item => item.value);
        const colorMap = { 'Conforme': '#4facfe', 'Disconforme': '#fee140', 'Pendiente': '#a8b8d8' };
        const colors = labels.map(label => colorMap[label] || '#a8b8d8');
        
        // Crear array de datos con colores y ordenar por valor descendente
        const dataWithColors = data.filter(item => item.value > 0).map(item => ({
            value: item.value,
            color: colorMap[item.label] || '#a8b8d8'
        })).sort((a, b) => b.value - a.value);
        
        // Crear gradiente din√°mico basado en predominancia
        const gradientColors = dataWithColors.map(item => item.color).join(', ');
        const chartBox = document.getElementById('chartConformidadGlobal').closest('.chart-box');
        chartBox.style.setProperty('--dynamic-gradient', `linear-gradient(90deg, ${gradientColors})`);
        
        chartConformidadGlobalInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            boxWidth: 14, 
                            font: { size: 11, weight: '500' },
                            padding: 12,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-main').trim()
                        } 
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value, ctx) => {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return percentage + '%';
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
    
    async function cargarGraficosGlobales() {
        try {
            console.log('üîÑ Cargando gr√°ficos globales desde:', API_DASHBOARD_URL);
            const respuesta = await fetch(API_DASHBOARD_URL);
            
            if (!respuesta.ok) {
                throw new Error(`Error HTTP: ${respuesta.status}`);
            }
            
            const data = await respuesta.json();
            console.log('üìä Datos recibidos del endpoint:', data);
            
            // Los datos ya vienen agrupados en el formato correcto
            const { numEmpleados, categorias, firmados, conformidades } = data;
            
            console.log('Datos agrupados:', { numEmpleados, categorias, firmados, conformidades });
            
            // Crear gr√°ficos con los datos agrupados
            if (numEmpleados && numEmpleados.value > 0) {
                console.log('‚úÖ Creando gr√°fico de N¬∞ Empleados');
                crearGraficoNumEmpleadosGlobal([numEmpleados]);
            }
            if (categorias && categorias.length > 0) {
                console.log('‚úÖ Creando gr√°fico de Categor√≠as');
                crearGraficoCategoriasGlobal(categorias);
            }
            if (firmados && firmados.length > 0) {
                console.log('‚úÖ Creando gr√°fico de Firmado');
                crearGraficoFirmadoGlobal(firmados);
            }
            if (conformidades && conformidades.length > 0) {
                console.log('‚úÖ Creando gr√°fico de Conformidad');
                crearGraficoConformidadGlobal(conformidades);
            }
            
            // Ocultar mensaje de carga y mostrar gr√°ficos
            document.getElementById('panelEstado').classList.add('hidden');
            document.getElementById('chartsGlobales').classList.remove('hidden');
            console.log('‚úÖ Gr√°ficos globales cargados correctamente');
            
        } catch (error) {
            console.error('‚ùå Error al cargar gr√°ficos globales:', error);
            console.error('Detalles del error:', error.message);
            
            // Mostrar mensaje de error al usuario
            const panelEstado = document.getElementById('panelEstado');
            panelEstado.innerHTML = `
                <p style="color: red;">‚ùå Error al cargar los gr√°ficos.</p>
                <p>Por favor, verifique la conexi√≥n con el servidor.</p>
            `;
        }
    }
    
    // Funciones de navegaci√≥n para los botones de acci√≥n
    async function irALegajos() {
        try {
            console.log('üìÅ Obteniendo token para navegar a Legajos...');
            
            // Construir URL con par√°metros para obtener el token
            const tokenUrl = `${API_DASHBOARD_URL}?action=get_auth_token&username=lcreo@grupolpa.com&password=12345&tipo=Legajos`;
            console.log('üì§ Solicitando token desde:', tokenUrl);
            
            // Hacer petici√≥n GET al backend para obtener el token
            const response = await fetch(tokenUrl);
            
            console.log('üì• Respuesta recibida. Status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Error en respuesta:', errorText);
                throw new Error(`Error al obtener token: ${response.status} - ${errorText}`);
            }
            
            // Obtener el token como texto plano
            const token = await response.text();
            console.log('üì• Token recibido:', token.substring(0, 50) + '...');
            
            if (!token || token.trim() === '') {
                console.error('‚ùå Token vac√≠o o inv√°lido');
                throw new Error('No se recibi√≥ el token de autenticaci√≥n en la respuesta');
            }
            
            console.log('‚úÖ Token obtenido exitosamente:', token.substring(0, 50) + '...');
            
            // Construir la URL final con el token
            const finalUrl = `http://172.16.16.60:8096/loginWithToken?library=32a76e80-1d2d-47fe-9b9d-d423cf644d71&callback=/widgets/storedsearch&token=${token}`;
            
            console.log('üöÄ Navegando a:', finalUrl);
            
            // Navegar a la URL
            window.location.href = finalUrl;
            
        } catch (error) {
            console.error('‚ùå Error completo:', error);
            console.error('‚ùå Mensaje de error:', error.message);
            console.error('‚ùå Stack:', error.stack);
            alert(`Error al autenticar: ${error.message}\n\nRevisa la consola para m√°s detalles.`);
        }
    }
    
    async function irAPendientes() {
        try {
            console.log('‚è∞ Obteniendo token para navegar a Pendientes de Firmar...');
            
            // Construir URL con par√°metros para obtener el token
            const tokenUrl = `${API_DASHBOARD_URL}?action=get_auth_token&username=lcreo@grupolpa.com&password=12345&tipo=Pendientes de firma`;
            console.log('üì§ Solicitando token desde:', tokenUrl);
            
            // Hacer petici√≥n GET al backend para obtener el token
            const response = await fetch(tokenUrl);
            
            console.log('üì• Respuesta recibida. Status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Error en respuesta:', errorText);
                throw new Error(`Error al obtener token: ${response.status} - ${errorText}`);
            }
            
            // Obtener el token como texto plano
            const token = await response.text();
            console.log('üì• Token recibido:', token.substring(0, 50) + '...');
            
            if (!token || token.trim() === '') {
                console.error('‚ùå Token vac√≠o o inv√°lido');
                throw new Error('No se recibi√≥ el token de autenticaci√≥n en la respuesta');
            }
            
            console.log('‚úÖ Token obtenido exitosamente:', token.substring(0, 50) + '...');
            
            // Construir la URL final con el token
            const finalUrl = `http://172.16.16.60:8096/loginWithToken?library=32a76e80-1d2d-47fe-9b9d-d423cf644d71&callback=/widgets/storedsearch&token=${token}`;
            
            console.log('üöÄ Navegando a:', finalUrl);
            
            // Navegar a la URL
            window.location.href = finalUrl;
            
        } catch (error) {
            console.error('‚ùå Error completo:', error);
            console.error('‚ùå Mensaje de error:', error.message);
            console.error('‚ùå Stack:', error.stack);
            alert(`Error al autenticar: ${error.message}\n\nRevisa la consola para m√°s detalles.`);
        }
    }
    
    async function irAFirmados() {
        try {
            console.log('‚úÖ Obteniendo token para navegar a Firmados...');
            
            // Construir URL con par√°metros para obtener el token
            const tokenUrl = `${API_DASHBOARD_URL}?action=get_auth_token&username=lcreo@grupolpa.com&password=12345&tipo=Firmados`;
            console.log('üì§ Solicitando token desde:', tokenUrl);
            
            // Hacer petici√≥n GET al backend para obtener el token
            const response = await fetch(tokenUrl);
            
            console.log('üì• Respuesta recibida. Status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Error en respuesta:', errorText);
                throw new Error(`Error al obtener token: ${response.status} - ${errorText}`);
            }
            
            // Obtener el token como texto plano
            const token = await response.text();
            console.log('üì• Token recibido:', token.substring(0, 50) + '...');
            
            if (!token || token.trim() === '') {
                console.error('‚ùå Token vac√≠o o inv√°lido');
                throw new Error('No se recibi√≥ el token de autenticaci√≥n en la respuesta');
            }
            
            console.log('‚úÖ Token obtenido exitosamente:', token.substring(0, 50) + '...');
            
            // Construir la URL final con el token
            const finalUrl = `http://172.16.16.60:8096/loginWithToken?library=32a76e80-1d2d-47fe-9b9d-d423cf644d71&callback=/widgets/storedsearch&token=${token}`;
            
            console.log('üöÄ Navegando a:', finalUrl);
            
            // Navegar a la URL
            window.location.href = finalUrl;
            
        } catch (error) {
            console.error('‚ùå Error completo:', error);
            console.error('‚ùå Mensaje de error:', error.message);
            console.error('‚ùå Stack:', error.stack);
            alert(`Error al autenticar: ${error.message}\n\nRevisa la consola para m√°s detalles.`);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // Cargar gr√°ficos globales al iniciar
        cargarGraficosGlobales();
    });
</script>

</body>
</html>
